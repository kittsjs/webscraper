import c from"express";import y from"express";import f from"puppeteer";var i=class{async extractProductImages(s){let t=null;try{console.log("Starting to scrape:",s),t=await f.launch({headless:"new",args:["--no-sandbox","--disable-setuid-sandbox","--disable-blink-features=AutomationControlled","--disable-dev-shm-usage","--disable-web-security","--disable-features=IsolateOrigins,site-per-process"],ignoreHTTPSErrors:!0});let e=await t.newPage();await e.setUserAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"),await e.setExtraHTTPHeaders({"Accept-Language":"en-US,en;q=0.9",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8","Accept-Encoding":"gzip, deflate, br",Connection:"keep-alive","Upgrade-Insecure-Requests":"1"}),await e.evaluateOnNewDocument(()=>{Object.defineProperty(navigator,"webdriver",{get:()=>!1}),Object.defineProperty(navigator,"plugins",{get:()=>[1,2,3,4,5]}),Object.defineProperty(navigator,"languages",{get:()=>["en-US","en"]})}),await e.setViewport({width:1920,height:1080}),console.log("Navigating to page...");try{await e.goto(s,{waitUntil:"load",timeout:6e4})}catch(a){if(a.message.includes("socket")||a.message.includes("hang up"))console.log("First attempt failed, trying alternative approach..."),await e.goto(s,{waitUntil:"networkidle2",timeout:6e4});else throw a}console.log("Page loaded, waiting for dynamic content..."),await new Promise(a=>setTimeout(a,2e3));let r;try{r=await e.evaluate(()=>{let a=document.querySelectorAll("img").length,o=a>0;return{loaded:!0,title:document.title,imageCount:a,hasImages:o,readyState:document.readyState}})}catch(a){if(a.message.includes("detached")||a.message.includes("Target closed"))console.log("Page navigated away, trying to wait for new page..."),await new Promise(o=>setTimeout(o,2e3)),r=await e.evaluate(()=>{let o=document.querySelectorAll("img").length,w=o>0;return{loaded:!0,title:document.title,imageCount:o,hasImages:w,readyState:document.readyState}});else throw a}return console.log("Page loaded:",r),[]}catch(e){throw console.error("Error in scraper:",e.message),console.error("Error stack:",e.stack),e.message.includes("socket")||e.message.includes("hang up")?new Error(`Connection was closed by the server. This often happens with sites that have bot detection (like Myntra, Flipkart, Amazon). Error: ${e.message}`):new Error(`Failed to extract images: ${e.message}`)}finally{t&&await t.close()}}},p=new i;var n=class{async extractImages(s,t){try{let{url:e}=s.query;if(console.log("url",e),!e)return t.status(400).json({success:!1,error:"URL parameter is required"});try{new URL(e)}catch{return t.status(400).json({success:!1,error:"Invalid URL format"})}let r=await p.extractProductImages(e);t.json({success:!0,url:e,imageCount:r.length,images:r})}catch(e){t.status(500).json({success:!1,error:e.message})}}},l=new n;var d=y.Router();d.get("/extract-images",l.extractImages.bind(l));var m=d;var g=class{constructor(){this.app=c(),this.port=process.env.PORT||3e3,this.initializeMiddleware(),this.initializeRoutes()}initializeMiddleware(){this.app.use(c.json()),this.app.use(c.urlencoded({extended:!0})),this.app.use((s,t,e)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE"),t.header("Access-Control-Allow-Headers","Content-Type"),e()})}initializeRoutes(){this.app.get("/",(s,t)=>{t.json({message:"Kloth.me Image Scraper API",endpoints:{extractImages:"GET /api/extract-images?url=<ecommerce-url>"}})}),this.app.use("/api",m),this.app.use((s,t)=>{t.status(404).json({success:!1,error:"Endpoint not found"})})}start(){this.app.listen(this.port,()=>{console.log(`Server is running on http://localhost:${this.port}`),console.log(`Try: http://localhost:${this.port}/api/extract-images?url=<your-ecommerce-url>`)})}},h=g;var x=new h;x.start();
